<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: transparent;
  font-family: 'Segoe UI', sans-serif;
  color: rgba(245,245,245,0.92);
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-user-select: none;
  user-select: none;
  padding: 24px 32px 48px;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.10); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.18); }

/* ---- Glass panels ---- */
.panel {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  margin-bottom: 20px;
  overflow: hidden;
}

.panel-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.panel-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: rgba(245,245,245,0.55);
}

/* ---- Buttons ---- */
.btn {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 6px;
  color: rgba(245,245,245,0.80);
  font-size: 11px;
  font-family: 'Segoe UI', sans-serif;
  padding: 4px 12px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}
.btn:hover { background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.16); }

.btn-gold {
  background: rgba(199,167,107,0.15);
  border-color: rgba(199,167,107,0.30);
  color: rgba(199,167,107,0.90);
}
.btn-gold:hover { background: rgba(199,167,107,0.25); }

.btn-danger {
  background: rgba(220,60,60,0.10);
  border-color: rgba(220,60,60,0.25);
  color: rgba(220,100,100,0.90);
}
.btn-danger:hover { background: rgba(220,60,60,0.20); }

/* ---- Tables ---- */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

thead th {
  text-align: left;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  color: rgba(245,245,245,0.35);
  padding: 8px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  position: sticky;
  top: 0;
  background: rgba(15,20,28,0.95);
}

tbody td {
  padding: 7px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  color: rgba(245,245,245,0.75);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

tbody tr:hover { background: rgba(255,255,255,0.03); }

.cell-title {
  max-width: 340px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cell-num { text-align: right; }

.muted { color: rgba(245,245,245,0.30); }
.muted-row td { color: rgba(245,245,245,0.30); }

/* ---- Progress bar ---- */
.progress-bar {
  width: 100%;
  max-width: 120px;
  height: 6px;
  background: rgba(255,255,255,0.06);
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: rgba(199,167,107,0.65);
  border-radius: 3px;
  transition: width 0.3s ease;
}

/* ---- Status badges ---- */
.badge {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
  letter-spacing: 0.5px;
}

.badge-downloading { background: rgba(199,167,107,0.15); color: rgba(199,167,107,0.90); }
.badge-completed { background: rgba(80,180,80,0.15); color: rgba(100,200,100,0.90); }
.badge-paused { background: rgba(255,255,255,0.06); color: rgba(245,245,245,0.45); }
.badge-error { background: rgba(220,60,60,0.15); color: rgba(220,100,100,0.90); }
.badge-seeding { background: rgba(80,140,220,0.15); color: rgba(100,160,240,0.90); }

/* ---- Search form ---- */
.search-form {
  display: flex;
  gap: 8px;
  align-items: center;
  flex: 1;
}

.search-input {
  flex: 1;
  height: 32px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 6px;
  padding: 0 12px;
  font-size: 12px;
  font-family: 'Segoe UI', sans-serif;
  color: rgba(245,245,245,0.92);
  outline: none;
  transition: border-color 0.2s;
}
.search-input:focus { border-color: rgba(199,167,107,0.35); }
.search-input::placeholder { color: rgba(245,245,245,0.25); }

.search-select {
  height: 32px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 6px;
  padding: 0 8px;
  font-size: 11px;
  font-family: 'Segoe UI', sans-serif;
  color: rgba(245,245,245,0.75);
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
}

.search-status {
  font-size: 10px;
  color: rgba(245,245,245,0.35);
  padding: 4px 12px;
}

/* ---- Table wrapper (scroll) ---- */
.table-wrap {
  max-height: 280px;
  overflow-y: auto;
}

/* ---- Spacer ---- */
.spacer { flex: 1; }

/* ---- Header title ---- */
.hub-title {
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(199,167,107,0.50);
  margin-bottom: 20px;
  text-align: center;
}
</style>
</head>
<body>

<div class="hub-title">TANKOBAN HUB</div>

<!-- ========== SEARCH ========== -->
<div class="panel">
  <div class="panel-header">
    <span class="panel-title">Search</span>
    <div class="search-form">
      <input class="search-input" id="searchInput" type="text" placeholder="Search torrents..." autofocus>
      <select class="search-select" id="searchProvider" title="Search provider">
        <option value="prowlarr">Prowlarr</option>
        <option value="jackett">Jackett</option>
      </select>
      <select class="search-select" id="searchSource">
        <option value="all">All Indexers</option>
      </select>
      <button class="btn btn-gold" id="searchBtn">Search</button>
      <button class="btn" id="configIndexersBtn" title="Configure indexers">&#9881; Indexers</button>
    </div>
  </div>
  <div id="searchStatus" class="search-status"></div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th class="cell-title">Title</th>
          <th>Size</th>
          <th class="cell-num">Files</th>
          <th class="cell-num">Seeders</th>
          <th>Source</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="searchBody">
        <tr class="muted-row"><td colspan="6" style="text-align:center; padding:20px;">Search for torrents above.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ========== ACTIVE TORRENTS ========== -->
<div class="panel">
  <div class="panel-header">
    <span class="panel-title">Active Torrents</span>
    <div class="spacer"></div>
    <button class="btn" id="resumeAllBtn" title="Resume all">Resume All</button>
    <button class="btn" id="pauseAllBtn" title="Pause all">Pause All</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:30px">#</th>
          <th class="cell-title">Name</th>
          <th>Size</th>
          <th>Speed</th>
          <th style="width:140px">Progress</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="torrentsBody">
        <tr class="muted-row"><td colspan="7" style="text-align:center; padding:20px;">No active torrents.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ========== DOWNLOADS ========== -->
<div class="panel">
  <div class="panel-header">
    <span class="panel-title">Downloads</span>
    <div class="spacer"></div>
    <button class="btn" id="clearDownloadsBtn">Clear Completed</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:30px">#</th>
          <th class="cell-title">Name</th>
          <th>Size</th>
          <th>Speed</th>
          <th style="width:140px">Progress</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="downloadsBody">
        <tr class="muted-row"><td colspan="6" style="text-align:center; padding:20px;">No downloads yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/* ---- Formatting helpers ---- */
function formatBytes(bytes) {
  if (!bytes || bytes <= 0) return '-';
  var units = ['B', 'KB', 'MB', 'GB', 'TB'];
  var i = 0;
  var b = bytes;
  while (b >= 1024 && i < units.length - 1) { b /= 1024; i++; }
  return (i === 0 ? b : b.toFixed(1)) + ' ' + units[i];
}

function formatSpeed(bytesPerSec) {
  if (!bytesPerSec || bytesPerSec <= 0) return '-';
  return formatBytes(bytesPerSec) + '/s';
}

function formatPct(ratio) {
  if (ratio == null || ratio < 0) return '0%';
  if (ratio >= 1) return '100%';
  return Math.round(ratio * 100) + '%';
}

function escapeHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function statusBadge(state) {
  var s = (state || '').toLowerCase();
  var cls = 'badge-paused';
  var label = state || 'unknown';
  if (s === 'downloading' || s === 'stalledDL' || s.indexOf('download') >= 0) {
    cls = 'badge-downloading'; label = 'Downloading';
  } else if (s === 'completed' || s === 'uploading' || s === 'stalledUP' || s.indexOf('complete') >= 0) {
    cls = 'badge-completed'; label = 'Completed';
  } else if (s === 'pausedDL' || s === 'pausedUP' || s.indexOf('pause') >= 0) {
    cls = 'badge-paused'; label = 'Paused';
  } else if (s === 'error' || s.indexOf('error') >= 0) {
    cls = 'badge-error'; label = 'Error';
  } else if (s.indexOf('seed') >= 0) {
    cls = 'badge-seeding'; label = 'Seeding';
  } else if (s.indexOf('queue') >= 0) {
    cls = 'badge-paused'; label = 'Queued';
  } else if (s.indexOf('check') >= 0) {
    cls = 'badge-downloading'; label = 'Checking';
  } else if (s.indexOf('meta') >= 0) {
    cls = 'badge-downloading'; label = 'Metadata';
  }
  return '<span class="badge ' + cls + '">' + escapeHtml(label) + '</span>';
}

function progressBar(ratio) {
  var pct = Math.min(100, Math.max(0, Math.round((ratio || 0) * 100)));
  return '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>' +
         '<span style="font-size:10px;color:rgba(245,245,245,0.45);margin-left:6px;">' + pct + '%</span>';
}

/* ---- Search results ---- */
var _searchResults = [];

function updateSearchResults(data) {
  _searchResults = data || [];
  var body = document.getElementById('searchBody');
  if (!_searchResults.length) {
    body.innerHTML = '<tr class="muted-row"><td colspan="6" style="text-align:center;padding:20px;">No results.</td></tr>';
    return;
  }
  var html = '';
  for (var i = 0; i < _searchResults.length; i++) {
    var r = _searchResults[i];
    html += '<tr>'
      + '<td class="cell-title" title="' + escapeHtml(r.title || '') + '">' + escapeHtml(r.title || '-') + '</td>'
      + '<td>' + formatBytes(r.sizeBytes) + '</td>'
      + '<td class="cell-num">' + (r.fileCount != null ? r.fileCount : '-') + '</td>'
      + '<td class="cell-num">' + (r.seeders != null ? r.seeders : 0) + '</td>'
      + '<td>' + escapeHtml(r.sourceName || '') + '</td>'
      + '<td><button class="btn btn-gold" data-magnet-idx="' + i + '">Magnet</button></td>'
      + '</tr>';
  }
  body.innerHTML = html;
}

function setSearchLoading(on) {
  document.getElementById('searchStatus').textContent = on ? 'Searching...' : '';
}

function setSearchResultCount(count, filtered) {
  var el = document.getElementById('searchStatus');
  if (filtered != null && filtered !== count) {
    el.textContent = filtered + ' filtered / ' + count + ' result(s)';
  } else {
    el.textContent = count + ' result(s)';
  }
}

/* ---- Torrents table ---- */
var _torrents = [];

function updateTorrents(data) {
  _torrents = data || [];
  var body = document.getElementById('torrentsBody');
  if (!_torrents.length) {
    body.innerHTML = '<tr class="muted-row"><td colspan="7" style="text-align:center;padding:20px;">No active torrents.</td></tr>';
    return;
  }
  var html = '';
  for (var i = 0; i < _torrents.length; i++) {
    var t = _torrents[i];
    var ratio = (t.progress != null) ? t.progress : (t.size > 0 ? t.completed / t.size : 0);
    html += '<tr data-hash="' + escapeHtml(t.hash || '') + '">'
      + '<td>' + (i + 1) + '</td>'
      + '<td class="cell-title" title="' + escapeHtml(t.name || '') + '">' + escapeHtml(t.name || '-') + '</td>'
      + '<td>' + formatBytes(t.size || t.total_size) + '</td>'
      + '<td>' + formatSpeed(t.dlspeed) + '</td>'
      + '<td style="display:flex;align-items:center;gap:4px;">' + progressBar(ratio) + '</td>'
      + '<td>' + statusBadge(t.state) + '</td>'
      + '<td>'
      + '<button class="btn" data-torrent-action="pause" data-hash="' + escapeHtml(t.hash || '') + '" title="Pause" style="padding:2px 6px;">⏸</button> '
      + '<button class="btn" data-torrent-action="resume" data-hash="' + escapeHtml(t.hash || '') + '" title="Resume" style="padding:2px 6px;">▶</button> '
      + '<button class="btn btn-danger" data-torrent-action="delete" data-hash="' + escapeHtml(t.hash || '') + '" title="Delete" style="padding:2px 6px;">✕</button>'
      + '</td>'
      + '</tr>';
  }
  body.innerHTML = html;
}

/* ---- Downloads table ---- */
var _downloads = [];

function updateDownloads(data) {
  _downloads = data || [];
  var body = document.getElementById('downloadsBody');
  if (!_downloads.length) {
    body.innerHTML = '<tr class="muted-row"><td colspan="6" style="text-align:center;padding:20px;">No downloads yet.</td></tr>';
    return;
  }
  var html = '';
  for (var i = 0; i < _downloads.length; i++) {
    var d = _downloads[i];
    var ratio = d.size > 0 ? (d.received || 0) / d.size : 0;
    html += '<tr>'
      + '<td>' + (i + 1) + '</td>'
      + '<td class="cell-title" title="' + escapeHtml(d.name || '') + '">' + escapeHtml(d.name || '-') + '</td>'
      + '<td>' + formatBytes(d.size) + '</td>'
      + '<td>' + formatSpeed(d.speed) + '</td>'
      + '<td style="display:flex;align-items:center;gap:4px;">' + progressBar(ratio) + '</td>'
      + '<td>' + statusBadge(d.status) + '</td>'
      + '</tr>';
  }
  body.innerHTML = html;
}

/* ---- Sources dropdown ---- */
var _prowlarrIndexers = [];
var _jackettIndexers = [];

function updateSources(indexers) {
  _prowlarrIndexers = (indexers || []).filter(function(ix) { return ix.provider !== 'jackett'; });
  _rebuildSourceDropdown();
}

function updateJackettSources(indexers) {
  _jackettIndexers = indexers || [];
  _rebuildSourceDropdown();
}

function _rebuildSourceDropdown() {
  var provider = document.getElementById('searchProvider').value;
  var sel = document.getElementById('searchSource');
  sel.innerHTML = '<option value="all">All Indexers</option>';
  var list = provider === 'jackett' ? _jackettIndexers : _prowlarrIndexers;
  list.forEach(function(ix) {
    if (ix.enabled !== false) {
      var opt = document.createElement('option');
      opt.value = ix.id;
      opt.textContent = ix.name;
      sel.appendChild(opt);
    }
  });
}

/* Provider availability */
var _prowlarrAvailable = false;
var _jackettAvailable = false;

function setProviderStatus(provider, available) {
  if (provider === 'prowlarr') _prowlarrAvailable = available;
  if (provider === 'jackett') _jackettAvailable = available;
  var provSel = document.getElementById('searchProvider');
  /* Auto-select an available provider */
  if (!_prowlarrAvailable && _jackettAvailable) provSel.value = 'jackett';
  else if (_prowlarrAvailable && !_jackettAvailable) provSel.value = 'prowlarr';
  /* Show/hide provider options */
  for (var i = 0; i < provSel.options.length; i++) {
    var opt = provSel.options[i];
    if (opt.value === 'prowlarr') opt.disabled = !_prowlarrAvailable;
    if (opt.value === 'jackett') opt.disabled = !_jackettAvailable;
  }
  _rebuildSourceDropdown();
}

/* ---- Communication with Python (tankoweb:// scheme) ---- */
function _doSearch() {
  var q = document.getElementById('searchInput').value.trim();
  if (!q) return;
  var source = document.getElementById('searchSource').value;
  var provider = document.getElementById('searchProvider').value;
  window.location.href = 'tankoweb://hub-search?q=' + encodeURIComponent(q) + '&source=' + encodeURIComponent(source) + '&provider=' + encodeURIComponent(provider);
}

/* Search button + Enter key */
document.getElementById('searchBtn').addEventListener('click', _doSearch);
document.getElementById('searchInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') _doSearch();
});

/* Provider dropdown change → rebuild source list */
document.getElementById('searchProvider').addEventListener('change', _rebuildSourceDropdown);

/* Configure Indexers — opens Prowlarr or Jackett web UI in a new tab */
var _prowlarrUrl = '';
var _jackettUrl = '';
function setProwlarrUrl(url) {
  _prowlarrUrl = url;
}
function setJackettUrl(url) {
  _jackettUrl = url;
}
document.getElementById('configIndexersBtn').addEventListener('click', function() {
  var provider = document.getElementById('searchProvider').value;
  var url = '';
  if (provider === 'jackett') {
    url = _jackettUrl || 'http://127.0.0.1:9117';
  } else {
    url = _prowlarrUrl || 'http://127.0.0.1:9696';
  }
  window.location.href = 'tankoweb://open-url?url=' + encodeURIComponent(url);
});

/* Magnet button clicks (delegated) */
document.getElementById('searchBody').addEventListener('click', function(e) {
  var btn = e.target.closest('[data-magnet-idx]');
  if (!btn) return;
  var idx = parseInt(btn.getAttribute('data-magnet-idx'), 10);
  var r = _searchResults[idx];
  if (!r) return;
  var uri = r.magnetUri || r.downloadUrl || '';
  if (uri) {
    window.location.href = 'tankoweb://hub-add-magnet?uri=' + encodeURIComponent(uri);
    btn.textContent = 'Added';
    btn.disabled = true;
    btn.style.opacity = '0.5';
  }
});

/* Torrent action buttons (delegated) */
document.getElementById('torrentsBody').addEventListener('click', function(e) {
  var btn = e.target.closest('[data-torrent-action]');
  if (!btn) return;
  var action = btn.getAttribute('data-torrent-action');
  var hash = btn.getAttribute('data-hash');
  if (action && hash) {
    window.location.href = 'tankoweb://hub-torrent-' + action + '?hash=' + encodeURIComponent(hash);
  }
});

/* Resume All / Pause All */
document.getElementById('resumeAllBtn').addEventListener('click', function() {
  window.location.href = 'tankoweb://hub-torrent-resume?hash=all';
});
document.getElementById('pauseAllBtn').addEventListener('click', function() {
  window.location.href = 'tankoweb://hub-torrent-pause?hash=all';
});

/* Clear completed downloads */
document.getElementById('clearDownloadsBtn').addEventListener('click', function() {
  window.location.href = 'tankoweb://hub-clear-downloads';
});
</script>
</body>
</html>
