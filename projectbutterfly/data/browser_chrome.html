<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ── Reset ── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    button { font-family: inherit; cursor: pointer; }
    input  { font-family: inherit; }

    /* ── Design tokens (dark default — overridden by applyTheme()) ── */
    :root {
      --bg1:        #0a0c14;          /* tab strip bg */
      --bg2:        #07090f;          /* nav bar bg */
      --bg3:        rgba(255,255,255,.04);  /* inactive tab bg */
      --text:       rgba(245,245,245,.92);
      --muted:      rgba(245,245,245,.46);
      --accent-rgb: 199,167,107;      /* muted gold */
      --accent2-rgb:156,163,175;      /* smoke grey */
      --chr-rgb:    255,255,255;
      --border:     rgba(255,255,255,.10);
      --border2:    rgba(255,255,255,.16);
      --btn-hover:  rgba(255,255,255,.08);
      --btn-press:  rgba(255,255,255,.14);
      --tab-hover:  rgba(255,255,255,.06);
      --addr-bg:    rgba(255,255,255,.05);
      --addr-focus: rgba(255,255,255,.08);
      --radius:     10px;
    }

    /* ── Root layout ── */
    html, body {
      width: 100%; height: 76px; overflow: hidden;
      background: var(--bg1);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
                   Roboto, Helvetica, Arial, sans-serif;
      font-size: 13px;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      user-select: none;
    }

    /* ── Tab strip row (36px) ── */
    #tabStrip {
      display: flex;
      align-items: stretch;
      height: 36px;
      background: var(--bg1);
      border-bottom: 1px solid var(--border);
      padding: 0 4px;
      gap: 0;
    }

    /* ── Nav bar row (40px) ── */
    #navBar {
      display: flex;
      align-items: center;
      height: 40px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 0 8px;
      gap: 3px;
    }

    /* ── Shared button base ── */
    .iconBtn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      flex-shrink: 0;
      border: 1px solid rgba(var(--chr-rgb), .12);
      border-radius: var(--radius);
      background: rgba(var(--chr-rgb), .06);
      color: var(--text);
      transition:
        background-color .16s ease,
        border-color .16s ease,
        box-shadow .16s ease,
        transform .10s ease;
    }
    .iconBtn:hover  { background: var(--btn-hover); box-shadow: 0 12px 26px -18px rgba(0,0,0,.85); }
    .iconBtn:active { transform: translateY(1px) scale(.98); }
    .iconBtn:disabled, .iconBtn[disabled] {
      color: var(--muted); pointer-events: none; border-color: transparent;
      background: transparent;
    }

    /* ── Home button (tab strip, slightly taller to fill row) ── */
    #homeBtn {
      display: inline-flex; align-items: center; justify-content: center;
      width: 34px; height: 34px; flex-shrink: 0; align-self: center;
      border: 1px solid transparent;
      border-radius: var(--radius);
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      transition: background-color .16s ease, color .16s ease;
    }
    #homeBtn:hover { background: var(--btn-hover); color: var(--text); }
    #homeBtn:active { background: var(--btn-press); }

    /* ── Tab list (scrollable, flex-row) ── */
    #tabList {
      display: flex;
      align-items: flex-end;
      flex: 1;
      min-width: 0;
      height: 100%;
      padding: 4px 2px 0;
      gap: 2px;
      overflow-x: hidden;
    }

    /* ── Individual tab ── */
    .tab {
      display: flex;
      align-items: center;
      gap: 5px;
      height: 28px;
      padding: 0 8px 0 10px;
      min-width: 80px;
      max-width: 200px;
      flex-shrink: 1;
      border: 1px solid var(--border);
      border-bottom: none;
      border-top: 2px solid transparent;
      border-radius: 8px 8px 0 0;
      background: var(--bg3);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      overflow: hidden;
      white-space: nowrap;
      transition: background-color .12s ease, color .12s ease, border-top-color .12s ease;
      position: relative;
    }
    .tab:hover { background: var(--tab-hover); color: var(--text); }
    .tab.active {
      background: var(--bg2);
      color: var(--text);
      border-top: 2px solid rgba(var(--accent-rgb), .85);
      border-color: var(--border);
      border-bottom: none;
    }
    .tab-favicon {
      width: 14px; height: 14px; flex-shrink: 0;
      border-radius: 2px; object-fit: contain;
    }
    .tab-title {
      flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      font-size: 12px;
    }
    .tab-loading .tab-title::before {
      content: "↻ ";
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .tab-close {
      display: none; flex-shrink: 0;
      width: 16px; height: 16px; border-radius: 4px;
      border: none; background: transparent; color: var(--muted);
      font-size: 12px; padding: 0; cursor: pointer; align-items: center; justify-content: center;
      transition: background-color .12s ease, color .12s ease;
    }
    .tab:hover .tab-close, .tab.active .tab-close { display: inline-flex; }
    .tab-close:hover { background: rgba(248,81,73,.25); color: #f85149; }

    /* ── New tab button ── */
    #newTabBtn {
      display: inline-flex; align-items: center; justify-content: center;
      width: 28px; height: 28px; flex-shrink: 0; align-self: center;
      border: 1px solid transparent; border-radius: 8px;
      background: transparent; color: var(--muted); font-size: 18px;
      transition: background-color .16s ease, color .16s ease;
    }
    #newTabBtn:hover { background: var(--btn-hover); color: var(--text); }
    #newTabBtn:active { background: var(--btn-press); }

    /* ── Tab strip spacer ── */
    .ts-spacer { flex: 1; }

    /* ── Window controls ── */
    #wcGroup {
      display: flex;
      align-items: stretch;
      height: 100%;
    }
    .wc {
      display: flex; align-items: center; justify-content: center;
      width: 46px; height: 100%;
      border: none; border-radius: 0;
      background: transparent; color: var(--muted);
      font-size: 13px; font-family: "Segoe UI", system-ui, sans-serif;
      transition: background-color .12s ease, color .12s ease;
    }
    .wc:hover { background: rgba(var(--chr-rgb), .08); color: var(--text); }
    .wc:active { background: rgba(var(--chr-rgb), .14); }
    #wcClose:hover { background: #c42b1c !important; color: #fff !important; }

    /* ── Address bar ── */
    #addrBar {
      flex: 1;
      height: 30px;
      padding: 0 14px;
      border: 1px solid rgba(var(--chr-rgb), .12);
      border-radius: 18px;
      background: var(--addr-bg);
      color: var(--text);
      font-size: 12px;
      outline: none;
      caret-color: rgba(var(--accent-rgb), .9);
      transition: background-color .16s ease, border-color .16s ease, box-shadow .16s ease;
    }
    #addrBar::placeholder { color: var(--muted); }
    #addrBar:focus {
      background: var(--addr-focus);
      border-color: rgba(var(--accent-rgb), .50);
      box-shadow: 0 0 0 2px rgba(var(--accent-rgb), .14);
    }
    #addrBar::selection { background: rgba(var(--accent-rgb), .30); }

    /* ── Scrollbar (slim) ── */
    ::-webkit-scrollbar { width: 0; height: 0; }
  </style>
</head>
<body>

<!-- Inline Lucide SVG sprite -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="ic-arrow-left"   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></symbol>
  <symbol id="ic-arrow-right"  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></symbol>
  <symbol id="ic-rotate-cw"   viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></symbol>
  <symbol id="ic-square"      viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="6" height="6" x="9" y="9"/><circle cx="12" cy="12" r="10"/></symbol>
  <symbol id="ic-x"           viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></symbol>
  <symbol id="ic-bookmark"    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></symbol>
  <symbol id="ic-bookmark-fill" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></symbol>
  <symbol id="ic-clock"       viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16.5 14.25"/></symbol>
  <symbol id="ic-download"    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></symbol>
  <symbol id="ic-plus"        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></symbol>
  <symbol id="ic-home"        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></symbol>
</svg>

<!-- Tab strip row -->
<div id="tabStrip">
  <button id="homeBtn" title="Home">
    <svg width="16" height="16"><use href="#ic-home"/></svg>
  </button>

  <div id="tabList"></div>

  <button id="newTabBtn" title="New tab (Ctrl+T)">
    <svg width="16" height="16"><use href="#ic-plus"/></svg>
  </button>

  <div class="ts-spacer"></div>

  <div id="wcGroup">
    <button class="wc" id="wcMin"   title="Minimize">&#x2500;</button>
    <button class="wc" id="wcMax"   title="Maximize / Restore">&#x25A1;</button>
    <button class="wc" id="wcClose" title="Close">&#x00D7;</button>
  </div>
</div>

<!-- Navigation bar row -->
<div id="navBar">
  <button class="iconBtn" id="backBtn"   title="Back (Alt+Left)" disabled>
    <svg width="15" height="15"><use href="#ic-arrow-left"/></svg>
  </button>
  <button class="iconBtn" id="fwdBtn"    title="Forward (Alt+Right)" disabled>
    <svg width="15" height="15"><use href="#ic-arrow-right"/></svg>
  </button>
  <button class="iconBtn" id="reloadBtn" title="Reload (F5)">
    <svg width="15" height="15" id="reloadIcon"><use href="#ic-rotate-cw"/></svg>
  </button>

  <div style="width:6px;flex-shrink:0;"></div>

  <input id="addrBar" type="text" placeholder="Search or enter address" spellcheck="false" autocomplete="off">

  <div style="width:4px;flex-shrink:0;"></div>

  <button class="iconBtn" id="bookmarkBtn" title="Bookmark">
    <svg width="15" height="15" id="bookmarkIcon"><use href="#ic-bookmark"/></svg>
  </button>
  <button class="iconBtn" id="histBtn"     title="History">
    <svg width="15" height="15"><use href="#ic-clock"/></svg>
  </button>
  <button class="iconBtn" id="dlBtn"       title="Downloads">
    <svg width="15" height="15"><use href="#ic-download"/></svg>
  </button>
</div>

<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script>
'use strict';

// ── State ──────────────────────────────────────────────────────────────────
var _state = {
  tabs:        [],      // [{id, title, url, loading, canBack, canFwd}]
  activeId:    null,
  bookmarkUrl: null,
  bookmarked:  false,
};

var _cb = null;  // BrowserChromeBridge (set when QWebChannel initialises)

// ── Theme ──────────────────────────────────────────────────────────────────
var THEME_VARS = {
  dark:       { bg1:'#0a0c14', bg2:'#07090f', bg3:'rgba(255,255,255,.04)',
                text:'rgba(245,245,245,.92)', muted:'rgba(245,245,245,.46)',
                accentRgb:'199,167,107', accent2Rgb:'156,163,175',
                border:'rgba(255,255,255,.10)', btnHover:'rgba(255,255,255,.08)',
                btnPress:'rgba(255,255,255,.14)', tabHover:'rgba(255,255,255,.06)',
                addrBg:'rgba(255,255,255,.05)', addrFocus:'rgba(255,255,255,.08)' },
  light:      { bg1:'#e8e8ee', bg2:'#dcdce4', bg3:'rgba(0,0,0,.04)',
                text:'rgba(20,20,24,.90)', muted:'rgba(20,20,24,.50)',
                accentRgb:'88,101,242', accent2Rgb:'100,116,139',
                border:'rgba(0,0,0,.10)', btnHover:'rgba(0,0,0,.06)',
                btnPress:'rgba(0,0,0,.10)', tabHover:'rgba(0,0,0,.04)',
                addrBg:'rgba(0,0,0,.04)', addrFocus:'rgba(0,0,0,.07)' },
  nord:       { bg1:'#2e3440', bg2:'#252932', bg3:'rgba(255,255,255,.05)',
                text:'#eceff4', muted:'#9099aa',
                accentRgb:'94,129,172', accent2Rgb:'136,192,208',
                border:'rgba(255,255,255,.10)', btnHover:'rgba(255,255,255,.08)',
                btnPress:'rgba(255,255,255,.13)', tabHover:'rgba(255,255,255,.06)',
                addrBg:'rgba(255,255,255,.06)', addrFocus:'rgba(255,255,255,.10)' },
  solarized:  { bg1:'#002b36', bg2:'#00222c', bg3:'rgba(255,255,255,.04)',
                text:'#93a1a1', muted:'#586e75',
                accentRgb:'38,139,210', accent2Rgb:'42,161,152',
                border:'rgba(255,255,255,.08)', btnHover:'rgba(255,255,255,.06)',
                btnPress:'rgba(255,255,255,.10)', tabHover:'rgba(255,255,255,.05)',
                addrBg:'rgba(255,255,255,.05)', addrFocus:'rgba(255,255,255,.08)' },
  gruvbox:    { bg1:'#282828', bg2:'#1d2021', bg3:'rgba(255,255,255,.04)',
                text:'#ebdbb2', muted:'#928374',
                accentRgb:'215,153,33', accent2Rgb:'184,187,38',
                border:'rgba(255,255,255,.10)', btnHover:'rgba(255,255,255,.07)',
                btnPress:'rgba(255,255,255,.12)', tabHover:'rgba(255,255,255,.05)',
                addrBg:'rgba(255,255,255,.05)', addrFocus:'rgba(255,255,255,.09)' },
  catppuccin: { bg1:'#1e1e2e', bg2:'#181825', bg3:'rgba(255,255,255,.04)',
                text:'#cdd6f4', muted:'#a6adc8',
                accentRgb:'203,166,247', accent2Rgb:'137,180,250',
                border:'rgba(255,255,255,.09)', btnHover:'rgba(255,255,255,.07)',
                btnPress:'rgba(255,255,255,.11)', tabHover:'rgba(255,255,255,.05)',
                addrBg:'rgba(255,255,255,.05)', addrFocus:'rgba(255,255,255,.08)' },
};

function applyTheme(name) {
  var v = THEME_VARS[name] || THEME_VARS['dark'];
  var r = document.documentElement;
  r.style.setProperty('--bg1',       v.bg1);
  r.style.setProperty('--bg2',       v.bg2);
  r.style.setProperty('--bg3',       v.bg3);
  r.style.setProperty('--text',      v.text);
  r.style.setProperty('--muted',     v.muted);
  r.style.setProperty('--accent-rgb',  v.accentRgb);
  r.style.setProperty('--accent2-rgb', v.accent2Rgb);
  r.style.setProperty('--border',    v.border);
  r.style.setProperty('--btn-hover', v.btnHover);
  r.style.setProperty('--btn-press', v.btnPress);
  r.style.setProperty('--tab-hover', v.tabHover);
  r.style.setProperty('--addr-bg',   v.addrBg);
  r.style.setProperty('--addr-focus',v.addrFocus);
  document.body.dataset.theme = name;
}

// ── Tab rendering ──────────────────────────────────────────────────────────
function renderTabs(tabs) {
  var list = document.getElementById('tabList');
  var scrollLeft = list.scrollLeft;
  list.innerHTML = '';
  tabs.forEach(function(t) {
    var el = document.createElement('div');
    el.className = 'tab' + (t.id === _state.activeId ? ' active' : '') +
                   (t.loading ? ' tab-loading' : '');
    el.dataset.id = t.id;
    el.title = t.title || t.url || 'New Tab';

    var titleEl = document.createElement('span');
    titleEl.className = 'tab-title';
    titleEl.textContent = t.title || 'New Tab';
    el.appendChild(titleEl);

    var closeEl = document.createElement('button');
    closeEl.className = 'tab-close';
    closeEl.innerHTML = '<svg width="10" height="10"><use href="#ic-x"/></svg>';
    closeEl.title = 'Close tab';
    closeEl.addEventListener('click', function(e) {
      e.stopPropagation();
      if (_cb) _cb.closeTab(t.id);
    });
    el.appendChild(closeEl);

    el.addEventListener('click', function() {
      if (_cb && t.id !== _state.activeId) _cb.switchTab(t.id);
    });
    // Middle-click to close
    el.addEventListener('auxclick', function(e) {
      if (e.button === 1 && _cb) _cb.closeTab(t.id);
    });
    list.appendChild(el);
  });
  list.scrollLeft = scrollLeft;
}

// ── Address bar helpers ────────────────────────────────────────────────────
function _getActiveTab() {
  return _state.tabs.find(function(t) { return t.id === _state.activeId; }) || null;
}

function _setAddrBar(url) {
  var el = document.getElementById('addrBar');
  if (document.activeElement !== el) el.value = url || '';
}

function _syncNavButtons(tab) {
  var back   = document.getElementById('backBtn');
  var fwd    = document.getElementById('fwdBtn');
  var reload = document.getElementById('reloadBtn');
  var loading = tab ? tab.loading : false;
  if (tab && tab.canBack) back.removeAttribute('disabled');
  else back.setAttribute('disabled', '');
  if (tab && tab.canFwd) fwd.removeAttribute('disabled');
  else fwd.setAttribute('disabled', '');
  // Toggle reload icon: stop square when loading, rotate-cw otherwise
  document.getElementById('reloadIcon').innerHTML =
    loading ? '<use href="#ic-square"/>' : '<use href="#ic-rotate-cw"/>';
  reload.title = loading ? 'Stop loading (Esc)' : 'Reload (F5)';
}

function _syncBookmarkBtn() {
  var icon = document.getElementById('bookmarkIcon');
  icon.innerHTML = _state.bookmarked
    ? '<use href="#ic-bookmark-fill"/>'
    : '<use href="#ic-bookmark"/>';
  var btn = document.getElementById('bookmarkBtn');
  btn.style.color = _state.bookmarked ? 'rgba(var(--accent-rgb), 1)' : '';
}

// ── Public API (called by Python via runJavaScript) ────────────────────────
window._chrome = {

  setTabs: function(tabs) {
    _state.tabs = tabs || [];
    renderTabs(_state.tabs);
    var active = _getActiveTab();
    _syncNavButtons(active);
  },

  setActiveTab: function(tabId) {
    _state.activeId = tabId;
    renderTabs(_state.tabs);
    var active = _getActiveTab();
    _setAddrBar(active ? active.url : '');
    _syncNavButtons(active);
    // Reset bookmark icon until Python confirms
    _state.bookmarkUrl = active ? active.url : null;
    _syncBookmarkBtn();
  },

  updateTab: function(id, fields) {
    var tab = _state.tabs.find(function(t) { return t.id === id; });
    if (!tab) return;
    if (fields.title   !== undefined) tab.title   = fields.title;
    if (fields.url     !== undefined) tab.url     = fields.url;
    if (fields.loading !== undefined) tab.loading = fields.loading;
    if (fields.canBack !== undefined) tab.canBack = fields.canBack;
    if (fields.canFwd  !== undefined) tab.canFwd  = fields.canFwd;

    // Re-render tab element efficiently
    var tabEl = document.querySelector('.tab[data-id="' + id + '"]');
    if (tabEl) {
      var titleEl = tabEl.querySelector('.tab-title');
      if (titleEl) titleEl.textContent = tab.title || 'New Tab';
      if (tab.loading) tabEl.classList.add('tab-loading');
      else tabEl.classList.remove('tab-loading');
    }

    if (id === _state.activeId) {
      _setAddrBar(tab.url);
      _syncNavButtons(tab);
    }
  },

  setBookmark: function(data) {
    _state.bookmarkUrl = data.url;
    _state.bookmarked  = !!data.bookmarked;
    _syncBookmarkBtn();
  },

  applyTheme: function(name) {
    applyTheme(name);
  },

  setMaximized: function(maximized) {
    document.getElementById('wcMax').textContent = maximized ? '\u2750' : '\u25A1';
  },

  focusAddrBar: function() {
    var el = document.getElementById('addrBar');
    el.focus();
    el.select();
  },
};

// ── Navigation helpers ─────────────────────────────────────────────────────
function _submitAddr() {
  var raw = document.getElementById('addrBar').value.trim();
  if (!raw || !_cb) return;
  var url = _normalizeUrl(raw);
  var active = _getActiveTab();
  if (active) _cb.navigate(active.id, url);
  else _cb.createTab();
  document.getElementById('addrBar').blur();
}

function _normalizeUrl(text) {
  var t = text.trim();
  if (!t) return '';
  if (/^(https?|file|view-source):/.test(t)) return t;
  if (/^[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})(\/|$)/.test(t) && !/\s/.test(t)) return 'https://' + t;
  return 'https://www.google.com/search?q=' + encodeURIComponent(t);
}

// ── Button wiring ──────────────────────────────────────────────────────────
document.getElementById('homeBtn').addEventListener('click', function() {
  if (_cb) _cb.goHome();
});
document.getElementById('newTabBtn').addEventListener('click', function() {
  if (_cb) _cb.createTab();
});
document.getElementById('backBtn').addEventListener('click', function() {
  if (_cb && _state.activeId) _cb.goBack(_state.activeId);
});
document.getElementById('fwdBtn').addEventListener('click', function() {
  if (_cb && _state.activeId) _cb.goForward(_state.activeId);
});
document.getElementById('reloadBtn').addEventListener('click', function() {
  if (!_cb || !_state.activeId) return;
  var active = _getActiveTab();
  if (active && active.loading) _cb.stop(_state.activeId);
  else _cb.reload(_state.activeId);
});
document.getElementById('bookmarkBtn').addEventListener('click', function() {
  if (!_cb || !_state.activeId) return;
  var active = _getActiveTab();
  if (active) _cb.bookmarkToggle(active.url || '', active.title || '');
});
document.getElementById('histBtn').addEventListener('click', function() {
  if (_cb) _cb.showHistory();
});
document.getElementById('dlBtn').addEventListener('click', function() {
  if (_cb) _cb.showDownloads();
});

// Window controls
document.getElementById('wcMin').addEventListener('click',   function() { if (_cb) _cb.windowMinimize(); });
document.getElementById('wcMax').addEventListener('click',   function() { if (_cb) _cb.windowMaxRestore(); });
document.getElementById('wcClose').addEventListener('click', function() { if (_cb) _cb.windowClose(); });

// Address bar
document.getElementById('addrBar').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { _submitAddr(); }
  if (e.key === 'Escape') { this.blur(); }
});
document.getElementById('addrBar').addEventListener('focus', function() {
  this.select();
});

// ── Keyboard shortcuts (when chrome view has focus) ────────────────────────
document.addEventListener('keydown', function(e) {
  if (!_cb) return;
  var ctrl = e.ctrlKey || e.metaKey;
  var addr = document.getElementById('addrBar');
  var addrFocused = document.activeElement === addr;

  if (ctrl && e.key === 't') { e.preventDefault(); _cb.createTab(); return; }
  if (ctrl && e.key === 'w') { e.preventDefault(); if (_state.activeId) _cb.closeTab(_state.activeId); return; }
  if (ctrl && e.key === 'l') { e.preventDefault(); window._chrome.focusAddrBar(); return; }
  if (e.altKey && e.key === 'ArrowLeft')  { e.preventDefault(); if (_state.activeId) _cb.goBack(_state.activeId); return; }
  if (e.altKey && e.key === 'ArrowRight') { e.preventDefault(); if (_state.activeId) _cb.goForward(_state.activeId); return; }
  if ((e.key === 'F5' || (ctrl && e.key === 'r')) && !addrFocused) {
    e.preventDefault();
    var active = _getActiveTab();
    if (active) {
      if (active.loading) _cb.stop(_state.activeId);
      else _cb.reload(_state.activeId);
    }
    return;
  }
  if (ctrl && e.key === 'Tab')       { e.preventDefault(); _cb.cycleTabNext(); return; }
  if (ctrl && e.shiftKey && e.key === 'Tab') { e.preventDefault(); _cb.cycleTabPrev(); return; }
});

// ── QWebChannel init ──────────────────────────────────────────────────────
new QWebChannel(qt.webChannelTransport, function(channel) {
  _cb = channel.objects.chrome;

  // Load initial theme
  _cb.getAppTheme(function(theme) {
    applyTheme(theme || 'dark');
  });

  // Signal Python that chrome is ready to receive state
  _cb.chromeReady();
});
</script>
</body>
</html>
