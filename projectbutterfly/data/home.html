<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tankoban — Home</title>

<!-- Lucide icon subset (arrow-left, globe, search, settings, external-link) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="h-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
    <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
  </symbol>
  <symbol id="h-globe" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"/>
    <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/>
    <path d="M2 12h20"/>
  </symbol>
  <symbol id="h-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
  </symbol>
  <symbol id="h-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
    <circle cx="12" cy="12" r="3"/>
  </symbol>
  <symbol id="h-external-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
    <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
  </symbol>
</svg>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #0d1117;
  --bg2:       #161b22;
  --bg3:       #1a2030;
  --bg4:       #21262d;
  --accent:    #5865f2;
  --accent-h:  #6b78f5;
  --ok:        #3fb950;
  --warn:      #f0b429;
  --err:       #f85149;
  --text:      #e6edf3;
  --muted:     #8b949e;
  --border:    rgba(255,255,255,0.08);
  --card:      rgba(255,255,255,0.04);
  --card-h:    rgba(255,255,255,0.09);
  --radius:    10px;
  --radius-sm: 6px;
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Roboto, Helvetica, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.5;
  overflow-x: hidden;
}

body {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  min-height: 100%;
}

/* ── SVG icons ── */
.icon {
  width: 16px; height: 16px;
  display: inline-block;
  vertical-align: middle;
  flex-shrink: 0;
}

/* ── Top bar (window controls + Library ← / Browser →) ── */
.topbar {
  display: flex;
  flex-direction: column;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  flex-shrink: 0;
}

/* Window controls strip — sits at very top, right-aligned */
.wm-controls {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 0;
  padding: 4px 6px 0;
  height: 28px;
}

.wm-btn {
  width: 44px;
  height: 24px;
  background: none;
  border: none;
  color: var(--muted);
  font-size: 13px;
  font-family: inherit;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 3px;
  transition: background 0.1s, color 0.1s;
  flex-shrink: 0;
}
.wm-btn:hover           { background: rgba(255,255,255,0.08); color: var(--text); }
.wm-btn.wm-close:hover  { background: #c42b1c; color: #fff; }

/* Library / Browser row */
.topbar-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 18px 12px;
}

.topbar-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  border-radius: var(--radius-sm);
  padding: 5px 12px;
  font-size: 13px;
  font-family: inherit;
  cursor: pointer;
  transition: background 0.12s, color 0.12s, border-color 0.12s;
}
.topbar-btn:hover {
  background: var(--card-h);
  color: var(--text);
  border-color: rgba(255,255,255,0.18);
}

/* ── Scrollable content area ── */
.scroll-area {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 36px 24px 60px;
}

/* ── Page width container ── */
.page { width: 100%; max-width: 780px; }

/* ── Section header row (title + optional action) ── */
.section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 32px;
  margin-bottom: 10px;
}

.section-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--muted);
  flex: 1;
}

/* ── Search bar ── */
.search-wrap {
  display: flex;
  align-items: center;
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 28px;
  padding: 0 14px;
  gap: 8px;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.search-wrap:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(88,101,242,0.15);
}

.engine-select {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 12px;
  cursor: pointer;
  outline: none;
  padding: 0 2px;
  flex-shrink: 0;
  font-family: inherit;
  color-scheme: dark;
}
.engine-select option { background: var(--bg2); color: var(--text); }

.search-sep { width: 1px; height: 18px; background: var(--border); flex-shrink: 0; }

.search-input {
  flex: 1;
  background: none;
  border: none;
  color: var(--text);
  font-size: 15px;
  outline: none;
  padding: 13px 0;
  min-width: 0;
  font-family: inherit;
}
.search-input::placeholder { color: var(--muted); }

.search-btn {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  padding: 4px;
  border-radius: 4px;
  flex-shrink: 0;
  transition: color 0.12s;
}
.search-btn:hover { color: var(--accent); }
.search-btn .icon { width: 18px; height: 18px; }

/* ── Sources grid (Opera GX speed-dial) ── */
.sources-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 10px;
}

.source-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 7px;
  padding: 14px 8px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
  transition: background 0.1s, transform 0.1s, border-color 0.1s;
  user-select: none;
}
.source-card:hover { background: var(--card-h); transform: translateY(-1px); border-color: rgba(88,101,242,0.3); }
.source-card:active { transform: translateY(0); }

.source-icon {
  width: 32px; height: 32px;
  border-radius: 8px;
  background: var(--bg3);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0;
}
.source-icon img { width: 20px; height: 20px; object-fit: contain; }
.source-icon .icon { width: 18px; height: 18px; color: var(--muted); }

.source-label {
  font-size: 11px;
  color: var(--muted);
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%;
}

.sources-empty { color: var(--muted); font-size: 13px; padding: 8px 0; }

/* ── Icon-only button (Tools toggle etc.) ── */
.icon-btn {
  background: none;
  border: 1px solid transparent;
  color: var(--muted);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  padding: 4px;
  border-radius: var(--radius-sm);
  flex-shrink: 0;
  transition: color 0.12s, border-color 0.12s, background 0.12s;
}
.icon-btn:hover { color: var(--text); border-color: var(--border); background: var(--card); }
.icon-btn.active { color: var(--accent); border-color: rgba(88,101,242,0.4); background: rgba(88,101,242,0.08); }
.icon-btn .icon { width: 15px; height: 15px; }

/* ── Tools panel (Prowlarr / Jackett config) ── */
.tools-panel {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 10px;
}
.tools-panel.hidden { display: none; }

.tools-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.tools-label {
  font-size: 11px;
  color: var(--muted);
  flex-shrink: 0;
  min-width: 64px;
}

.tools-select, .tools-input {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 12px;
  font-family: inherit;
  padding: 5px 9px;
  outline: none;
  transition: border-color 0.15s;
}
.tools-select { cursor: pointer; color-scheme: dark; }
.tools-select option { background: var(--bg2); }
.tools-input { flex: 1; min-width: 0; }
.tools-input:focus, .tools-select:focus { border-color: var(--accent); }
.tools-input::placeholder { color: var(--muted); }

.tools-btn-row {
  display: flex;
  gap: 6px;
  justify-content: flex-end;
  align-items: center;
}

.tools-openui-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  border-radius: var(--radius-sm);
  padding: 4px 10px;
  font-size: 11px;
  font-family: inherit;
  cursor: pointer;
  transition: background 0.12s, color 0.12s;
}
.tools-openui-btn:hover { background: var(--card-h); color: var(--text); }
.tools-openui-btn .icon { width: 12px; height: 12px; }

.tools-save-btn {
  background: var(--accent);
  border: none;
  color: #fff;
  border-radius: var(--radius-sm);
  padding: 5px 16px;
  font-size: 12px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: background 0.12s;
}
.tools-save-btn:hover { background: var(--accent-h); }

.tools-status { font-size: 11px; color: var(--muted); }

/* ── Torrent search row ── */
.tsearch-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.tsearch-input {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 13px;
  font-family: inherit;
  padding: 7px 12px;
  outline: none;
  transition: border-color 0.15s;
  min-width: 0;
}
.tsearch-input:focus { border-color: var(--accent); }
.tsearch-input::placeholder { color: var(--muted); }

.tsearch-cat {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 12px;
  font-family: inherit;
  padding: 7px 10px;
  outline: none;
  cursor: pointer;
  flex-shrink: 0;
  color-scheme: dark;
}
.tsearch-cat option { background: var(--bg2); }

.tsearch-btn {
  background: var(--accent);
  border: none;
  color: #fff;
  border-radius: var(--radius-sm);
  padding: 7px 18px;
  font-size: 12px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.12s;
  white-space: nowrap;
}
.tsearch-btn:hover { background: var(--accent-h); }
.tsearch-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.tsearch-status { font-size: 12px; color: var(--muted); margin-top: 8px; min-height: 18px; }

/* ── Tables (torrent results + downloads) ── */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  font-size: 12px;
}
.data-table th {
  color: var(--muted);
  font-weight: 600;
  text-align: left;
  padding: 6px 8px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.data-table td {
  padding: 7px 8px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  vertical-align: middle;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: var(--card); }

.t-num    { color: var(--muted); text-align: right; width: 28px; }
.t-title  { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.t-size   { color: var(--muted); white-space: nowrap; }
.t-seeds  { color: var(--ok); white-space: nowrap; }
.t-speed  { color: var(--muted); white-space: nowrap; }
.t-pct    { white-space: nowrap; }
.t-dest   { color: var(--muted); white-space: nowrap; font-size: 11px; }
.t-type   { color: var(--muted); white-space: nowrap; font-size: 11px; }
.t-src    { color: var(--muted); white-space: nowrap; font-size: 11px; }
.t-action { white-space: nowrap; }

/* mini progress bar in table */
.pct-bar {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  width: 80px;
}
.pct-track {
  flex: 1;
  height: 3px;
  background: var(--bg4);
  border-radius: 2px;
  overflow: hidden;
}
.pct-fill { height: 100%; background: var(--accent); border-radius: 2px; }
.pct-fill.done { background: var(--ok); }

.btn-sm {
  background: var(--bg4);
  border: 1px solid var(--border);
  color: var(--muted);
  border-radius: var(--radius-sm);
  padding: 2px 8px;
  font-size: 11px;
  font-family: inherit;
  cursor: pointer;
  transition: background 0.1s, color 0.1s, border-color 0.1s;
  white-space: nowrap;
}
.btn-sm:hover { background: var(--bg3); color: var(--text); }
.btn-sm.add-btn:hover  { border-color: var(--accent); color: var(--accent); }
.btn-sm.cancel-btn:hover { border-color: var(--err); color: var(--err); }
.btn-sm.added { border-color: var(--ok); color: var(--ok); pointer-events: none; }
.btn-sm:disabled { opacity: 0.5; cursor: not-allowed; }

.tbl-empty { color: var(--muted); font-size: 12px; padding: 10px 0; }

/* ── Tips ── */
.tips {
  text-align: center;
  font-size: 11px;
  color: var(--muted);
  margin-top: 48px;
  line-height: 2;
}
.tips kbd {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 6px;
  font-family: inherit;
  font-size: 10px;
}
</style>
</head>
<body>

<!-- Top navigation bar -->
<div class="topbar">
  <!-- Window controls -->
  <div class="wm-controls">
    <button class="wm-btn" id="wmMinBtn" title="Minimize">&#x2013;</button>
    <button class="wm-btn" id="wmMaxBtn" title="Maximize">&#x25A1;</button>
    <button class="wm-btn wm-close" id="wmCloseBtn" title="Close">&#x2715;</button>
  </div>
  <!-- Library / Browser nav -->
  <div class="topbar-nav">
    <button class="topbar-btn" id="libraryBtn">
      <svg class="icon"><use href="#h-arrow-left"></use></svg>
      Library
    </button>
    <button class="topbar-btn" id="browserBtn">
      Browser
      <svg class="icon"><use href="#h-globe"></use></svg>
    </button>
  </div>
</div>

<!-- Scrollable content -->
<div class="scroll-area">
<div class="page">

  <!-- Search bar -->
  <div class="search-wrap">
    <select class="engine-select" id="engineSelect">
      <option value="yandex">Yandex</option>
      <option value="google">Google</option>
      <option value="duckduckgo">DuckDuckGo</option>
      <option value="brave">Brave</option>
      <option value="bing">Bing</option>
    </select>
    <div class="search-sep"></div>
    <input class="search-input" id="searchInput" type="text" placeholder="Search or enter address" autofocus>
    <button class="search-btn" id="searchBtn" title="Search">
      <svg class="icon"><use href="#h-search"></use></svg>
    </button>
  </div>

  <!-- Sources -->
  <div class="section-header" style="margin-top:28px">
    <span class="section-title">SOURCES</span>
  </div>
  <div class="sources-grid" id="sourcesGrid">
    <div class="sources-empty">Loading sources…</div>
  </div>

  <!-- Torrent search -->
  <div class="section-header">
    <span class="section-title">TORRENT SEARCH</span>
    <button class="icon-btn" id="toolsBtn" title="Configure Prowlarr / Jackett">
      <svg class="icon"><use href="#h-settings"></use></svg>
    </button>
  </div>

  <!-- Tools panel (hidden by default) -->
  <div class="tools-panel hidden" id="toolsPanel">
    <div class="tools-row">
      <span class="tools-label">Provider</span>
      <select class="tools-select" id="toolsProvider">
        <option value="jackett">Jackett</option>
        <option value="prowlarr">Prowlarr</option>
      </select>
    </div>
    <div class="tools-row">
      <span class="tools-label">Base URL</span>
      <input class="tools-input" id="toolsUrl" type="text" placeholder="http://localhost:9117">
    </div>
    <div class="tools-row">
      <span class="tools-label">API Key</span>
      <input class="tools-input" id="toolsApiKey" type="text" placeholder="API key">
    </div>
    <div class="tools-btn-row">
      <span class="tools-status" id="toolsStatus"></span>
      <button class="tools-openui-btn" id="toolsOpenUi">
        <svg class="icon"><use href="#h-external-link"></use></svg>
        Web UI
      </button>
      <button class="tools-save-btn" id="toolsSave">Save</button>
    </div>
  </div>

  <div class="tsearch-row">
    <input class="tsearch-input" id="tsearchInput" type="text" placeholder="Search torrents…">
    <select class="tsearch-cat" id="tsearchCat">
      <option value="all">All</option>
      <option value="comics">Comics</option>
      <option value="manga">Manga</option>
      <option value="books">Books</option>
      <option value="anime">Anime</option>
      <option value="tv">TV</option>
      <option value="movies">Movies</option>
    </select>
    <button class="tsearch-btn" id="tsearchBtn">Search</button>
  </div>
  <div class="tsearch-status" id="tsearchStatus"></div>
  <div id="tsearchResults"></div>

  <!-- Torrent downloads -->
  <div class="section-header">
    <span class="section-title">TORRENT DOWNLOADS</span>
  </div>
  <div id="torrentDlWrap">
    <div class="tbl-empty">No active torrent downloads.</div>
  </div>

  <!-- DDL downloads -->
  <div class="section-header">
    <span class="section-title">DDL DOWNLOADS</span>
  </div>
  <div id="ddlDlWrap">
    <div class="tbl-empty">No active direct downloads.</div>
  </div>


</div><!-- .page -->
</div><!-- .scroll-area -->

<script>
(function () {
  'use strict';

  // ── Theme sync ─────────────────────────────────────────────────────────────

  var THEME_VARS = {
    dark:       { bg:'#0d1117', bg2:'#161b22', bg3:'#1a2030', bg4:'#21262d', text:'#e6edf3', muted:'#8b949e', accent:'#5865f2', border:'rgba(255,255,255,0.08)' },
    light:      { bg:'#f5f5f7', bg2:'#eaeaef', bg3:'#dde1e7', bg4:'#cdd0d8', text:'rgba(20,20,24,0.90)', muted:'rgba(20,20,24,0.55)', accent:'#5865f2', border:'rgba(0,0,0,0.10)' },
    nord:       { bg:'#2e3440', bg2:'#3b4252', bg3:'#434c5e', bg4:'#4c566a', text:'#eceff4', muted:'#d8dee9', accent:'#5e81ac', border:'rgba(255,255,255,0.10)' },
    solarized:  { bg:'#002b36', bg2:'#073642', bg3:'#0d4a56', bg4:'#185566', text:'#839496', muted:'#657b83', accent:'#268bd2', border:'rgba(255,255,255,0.10)' },
    gruvbox:    { bg:'#282828', bg2:'#3c3836', bg3:'#504945', bg4:'#665c54', text:'#ebdbb2', muted:'#928374', accent:'#d79921', border:'rgba(255,255,255,0.10)' },
    catppuccin: { bg:'#1e1e2e', bg2:'#181825', bg3:'#313244', bg4:'#45475a', text:'#cdd6f4', muted:'#a6adc8', accent:'#cba6f7', border:'rgba(255,255,255,0.10)' },
  };

  window._tankwebApplyTheme = function (t) {
    var v = THEME_VARS[t] || THEME_VARS.dark;
    var r = document.documentElement;
    r.style.setProperty('--bg',     v.bg);
    r.style.setProperty('--bg2',    v.bg2);
    r.style.setProperty('--bg3',    v.bg3);
    r.style.setProperty('--bg4',    v.bg4);
    r.style.setProperty('--text',   v.text);
    r.style.setProperty('--muted',  v.muted);
    r.style.setProperty('--accent', v.accent);
    r.style.setProperty('--border', v.border);
    // derived colours that don't change per theme
    r.style.setProperty('--accent-h', v.accent);
    r.style.setProperty('--card',   'rgba(127,127,127,0.05)');
    r.style.setProperty('--card-h', 'rgba(127,127,127,0.10)');
    document.body.dataset.appTheme = t;
  };

  // ── Engine URL map ──────────────────────────────────────────────────────────

  var ENGINE_URLS = {
    yandex:     'https://yandex.com/search/?text=',
    google:     'https://www.google.com/search?q=',
    duckduckgo: 'https://duckduckgo.com/?q=',
    brave:      'https://search.brave.com/search?q=',
    bing:       'https://www.bing.com/search?q=',
  };

  var ENGINE_HOME = {
    yandex:     'https://yandex.com/',
    google:     'https://www.google.com/',
    duckduckgo: 'https://duckduckgo.com/',
    brave:      'https://search.brave.com/',
    bing:       'https://www.bing.com/',
  };

  // ── Helpers ────────────────────────────────────────────────────────────────

  function esc(s) {
    var d = document.createElement('div');
    d.textContent = String(s || '');
    return d.innerHTML;
  }

  function fmtSize(bytes) {
    var b = Number(bytes) || 0;
    if (b >= 1073741824) return (b / 1073741824).toFixed(1) + ' GB';
    if (b >= 1048576)    return (b / 1048576).toFixed(1) + ' MB';
    if (b >= 1024)       return (b / 1024).toFixed(0) + ' KB';
    return b ? b + ' B' : '—';
  }

  function fmtSpeed(bps) {
    var b = Number(bps) || 0;
    if (!b) return '—';
    if (b >= 1048576) return (b / 1048576).toFixed(1) + ' MB/s';
    if (b >= 1024)    return (b / 1024).toFixed(0) + ' KB/s';
    return b + ' B/s';
  }

  function fileExt(name) {
    var m = String(name || '').match(/\.([a-z0-9]{1,8})$/i);
    return m ? m[1].toLowerCase() : '—';
  }

  // ── Toast ──────────────────────────────────────────────────────────────────

  var _toastTimer = null;
  function showToast(msg) {
    var el = document.getElementById('homeToast');
    if (!el) {
      el = document.createElement('div');
      el.id = 'homeToast';
      el.style.cssText = [
        'position:fixed', 'bottom:24px', 'right:24px', 'z-index:9999',
        'background:var(--bg2)', 'color:var(--text)', 'border:1px solid var(--border)',
        'border-radius:8px', 'padding:10px 18px', 'font-size:13px',
        'box-shadow:0 4px 20px rgba(0,0,0,0.5)', 'pointer-events:none',
        'opacity:0', 'transition:opacity 0.2s',
      ].join(';');
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.opacity = '1';
    if (_toastTimer) clearTimeout(_toastTimer);
    _toastTimer = setTimeout(function () { el.style.opacity = '0'; }, 3000);
  }

  // ── Navigation helpers ─────────────────────────────────────────────────────

  function openNewTab(url) {
    var api = window.electronAPI;
    if (!api || !api.webTabManager) { window.location.href = url; return; }
    api.webTabManager.createTab({url: url, home: false}).then(function (r) {
      if (r && r.ok && r.tabId) {
        api.webTabManager.switchTab({tabId: r.tabId});
      }
    }).catch(function(){});
  }

  function doSearch(query) {
    query = String(query || '').trim();
    if (!query) return;
    var eng = document.getElementById('engineSelect').value;
    var url;
    if (/^https?:\/\/|^magnet:/i.test(query)) {
      url = query;
    } else if (/^[\w\-]+\.[\w\-]+/.test(query) && !query.includes(' ')) {
      url = 'https://' + query;
    } else {
      url = (ENGINE_URLS[eng] || ENGINE_URLS.yandex) + encodeURIComponent(query);
    }
    openNewTab(url);
  }

  // ── Window controls ────────────────────────────────────────────────────────

  document.getElementById('wmMinBtn').addEventListener('click', function () {
    var api = window.electronAPI;
    if (api && api.window) api.window.minimize().catch(function(){});
  });
  document.getElementById('wmMaxBtn').addEventListener('click', function () {
    var api = window.electronAPI;
    if (api && api.window) api.window.toggleMaximize().catch(function(){});
  });
  document.getElementById('wmCloseBtn').addEventListener('click', function () {
    var api = window.electronAPI;
    if (api && api.window) api.window.close().catch(function(){});
  });

  // ── Top bar buttons ────────────────────────────────────────────────────────

  document.getElementById('libraryBtn').addEventListener('click', function () {
    var api = window.electronAPI;
    if (api && api.webTabManager) {
      api.webTabManager.closeBrowser().catch(function(){});
    }
  });

  document.getElementById('browserBtn').addEventListener('click', function () {
    var eng = document.getElementById('engineSelect').value;
    openNewTab(ENGINE_HOME[eng] || ENGINE_HOME.yandex);
  });

  // ── Search bar ─────────────────────────────────────────────────────────────

  document.getElementById('searchBtn').addEventListener('click', function () {
    doSearch(document.getElementById('searchInput').value);
  });
  document.getElementById('searchInput').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') doSearch(this.value);
  });

  // ── Sources ────────────────────────────────────────────────────────────────

  function _globeSvg() {
    return '<svg class="icon" style="width:18px;height:18px;color:var(--muted)">'
         + '<use href="#h-globe"></use></svg>';
  }

  function renderSources(sources) {
    var grid = document.getElementById('sourcesGrid');
    if (!sources || !sources.length) {
      grid.innerHTML = '<div class="sources-empty">No sources configured.</div>';
      return;
    }
    var html = '';
    for (var i = 0; i < sources.length; i++) {
      var s = sources[i];
      var u = String(s.url || '');
      var iconHtml;
      try {
        var origin = new URL(u).origin;
        iconHtml = '<img src="' + esc(origin) + '/favicon.ico" width="20" height="20"'
                 + ' onerror="this.style.display=\'none\';this.nextSibling.style.display=\'flex\'" alt="">'
                 + '<span style="display:none;align-items:center;justify-content:center">' + _globeSvg() + '</span>';
      } catch(e) {
        iconHtml = '<span style="display:flex;align-items:center;justify-content:center">' + _globeSvg() + '</span>';
      }
      html += '<div class="source-card" data-url="' + esc(u) + '">'
            + '<div class="source-icon">' + iconHtml + '</div>'
            + '<span class="source-label">' + esc(s.name || u) + '</span>'
            + '</div>';
    }
    grid.innerHTML = html;
    grid.querySelectorAll('.source-card').forEach(function (card) {
      card.addEventListener('click', function () { openNewTab(card.getAttribute('data-url')); });
    });
  }

  // ── Tools panel (Prowlarr / Jackett config) ────────────────────────────────

  var _toolsOpen = false;
  var _toolsCfg  = null; // cached config from bridge

  function openToolsPanel() {
    _toolsOpen = true;
    document.getElementById('toolsPanel').classList.remove('hidden');
    document.getElementById('toolsBtn').classList.add('active');
    // Load current config
    var api = window.electronAPI;
    if (!api) return;
    api.torrentSearch.getConfig()
      .then(function (r) {
        if (!r || !r.ok) return;
        _toolsCfg = r;
        var provider = r.provider || 'jackett';
        document.getElementById('toolsProvider').value = provider;
        var cfg = r[provider] || r.current || {};
        document.getElementById('toolsUrl').value    = cfg.baseUrl || '';
        document.getElementById('toolsApiKey').value = cfg.apiKey  || '';
        document.getElementById('toolsStatus').textContent = '';
      })
      .catch(function(){});
  }

  function closeToolsPanel() {
    _toolsOpen = false;
    document.getElementById('toolsPanel').classList.add('hidden');
    document.getElementById('toolsBtn').classList.remove('active');
  }

  document.getElementById('toolsBtn').addEventListener('click', function () {
    if (_toolsOpen) { closeToolsPanel(); } else { openToolsPanel(); }
  });

  document.getElementById('toolsProvider').addEventListener('change', function () {
    if (!_toolsCfg) return;
    var provider = this.value;
    var cfg = _toolsCfg[provider] || {};
    document.getElementById('toolsUrl').value    = cfg.baseUrl || '';
    document.getElementById('toolsApiKey').value = cfg.apiKey  || '';
  });

  document.getElementById('toolsOpenUi').addEventListener('click', function () {
    var url = document.getElementById('toolsUrl').value.trim();
    if (url) openNewTab(url);
  });

  document.getElementById('toolsSave').addEventListener('click', function () {
    var provider = document.getElementById('toolsProvider').value;
    var url      = document.getElementById('toolsUrl').value.trim();
    var apiKey   = document.getElementById('toolsApiKey').value.trim();
    var status   = document.getElementById('toolsStatus');
    var payload  = { provider: provider };
    payload[provider] = { baseUrl: url, apiKey: apiKey };
    var api = window.electronAPI;
    if (!api) { status.textContent = 'Bridge not available.'; return; }
    status.textContent = 'Saving…';
    api.torrentSearch.saveSettings(JSON.stringify(payload))
      .then(function (r) {
        status.textContent = (r && r.ok) ? 'Saved.' : ('Error: ' + ((r && r.error) || 'unknown'));
        setTimeout(function () { status.textContent = ''; }, 2000);
      })
      .catch(function () { status.textContent = 'Save failed.'; });
  });

  // ── Torrent search ─────────────────────────────────────────────────────────

  var _tsearchBusy = false;

  function renderTorrentResults(items) {
    var el = document.getElementById('tsearchResults');
    if (!items || !items.length) { el.innerHTML = ''; return; }
    var html = '<table class="data-table"><thead><tr>'
             + '<th class="t-num">#</th><th class="t-title">Title</th>'
             + '<th class="t-size">Size</th><th class="t-seeds">Seeds</th>'
             + '<th class="t-src">Source</th><th></th>'
             + '</tr></thead><tbody>';
    for (var i = 0; i < items.length; i++) {
      var it = items[i];
      var mag = esc(it.magnetUri || it.magnet || '');
      var hasLink = !!(it.magnetUri || it.magnet);
      html += '<tr>'
            + '<td class="t-num">' + (i + 1) + '</td>'
            + '<td class="t-title" title="' + esc(it.title) + '">' + esc(it.title) + '</td>'
            + '<td class="t-size">' + fmtSize(it.size || it.Size || 0) + '</td>'
            + '<td class="t-seeds">' + (it.seeders || it.Seeders || 0) + '</td>'
            + '<td class="t-src">' + esc(it.tracker || it.indexer || '') + '</td>'
            + '<td class="t-action">';
      if (hasLink) {
        html += '<button class="btn-sm add-btn" data-magnet="' + mag + '">Add</button>';
      } else {
        html += '<span style="color:var(--muted);font-size:11px">—</span>';
      }
      html += '</td></tr>';
    }
    html += '</tbody></table>';
    el.innerHTML = html;

    el.querySelectorAll('.btn-sm.add-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var mag = btn.getAttribute('data-magnet');
        if (!mag || !window.electronAPI) return;
        btn.disabled = true;
        btn.textContent = '…';
        window.electronAPI.webTorrent.startMagnet({magnetUri: mag})
          .then(function () {
            btn.classList.add('added');
            btn.textContent = 'Added';
            showToast('Download started');
            setTimeout(refreshDownloads, 800);
          })
          .catch(function () {
            btn.disabled = false;
            btn.textContent = 'Add';
            showToast('Could not start download');
          });
      });
    });
  }

  function doTorrentSearch() {
    if (_tsearchBusy) return;
    var q = document.getElementById('tsearchInput').value.trim();
    if (!q) return;
    var cat = document.getElementById('tsearchCat').value;
    var btn    = document.getElementById('tsearchBtn');
    var status = document.getElementById('tsearchStatus');
    _tsearchBusy = true;
    btn.disabled = true;
    btn.textContent = '…';
    status.textContent = 'Searching…';
    document.getElementById('tsearchResults').innerHTML = '';

    if (!window.electronAPI) {
      status.textContent = 'Bridge not available.';
      _tsearchBusy = false; btn.disabled = false; btn.textContent = 'Search';
      return;
    }
    window.electronAPI.torrentSearch.query({query: q, category: cat})
      .then(function (r) {
        _tsearchBusy = false; btn.disabled = false; btn.textContent = 'Search';
        if (!r || !r.ok) {
          status.textContent = (r && r.error) || 'Not configured. Set up Jackett or Prowlarr in the Tools panel.';
          return;
        }
        var count = (r.items || []).length;
        status.textContent = count + ' result' + (count === 1 ? '' : 's')
          + (r.provider ? ' via ' + r.provider : '');
        renderTorrentResults(r.items || []);
      })
      .catch(function () {
        _tsearchBusy = false; btn.disabled = false; btn.textContent = 'Search';
        status.textContent = 'Search error.';
      });
  }

  document.getElementById('tsearchBtn').addEventListener('click', doTorrentSearch);
  document.getElementById('tsearchInput').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') doTorrentSearch();
  });

  // ── Torrent downloads table ────────────────────────────────────────────────

  function renderTorrentDownloads(torrents) {
    var wrap = document.getElementById('torrentDlWrap');
    var tl = torrents || [];
    if (!tl.length) {
      wrap.innerHTML = '<div class="tbl-empty">No active torrent downloads.</div>';
      return;
    }
    var html = '<table class="data-table"><thead><tr>'
             + '<th class="t-num">#</th><th class="t-title">Filename</th>'
             + '<th class="t-size">Size</th><th class="t-seeds">Seeds</th>'
             + '<th class="t-speed">Speed</th><th class="t-pct">Progress</th>'
             + '<th class="t-dest">Dest</th><th></th>'
             + '</tr></thead><tbody>';
    for (var i = 0; i < tl.length; i++) {
      var t = tl[i];
      var state = String(t.state || '');
      var isDone = (state === 'completed' || state === 'seeding');
      var isErr  = (state === 'failed' || state === 'error' || state === 'cancelled');
      var pct    = Math.min(100, Math.round((Number(t.progress) || 0) * 100));
      var speed  = (state === 'downloading') ? fmtSpeed(t.downloadRate || 0) : '—';
      var seeds  = (t.numPeers || t.seeders || 0);
      var dest   = String(t.destinationRoot || t.destination || '').split(/[\\/]/).pop() || '—';
      var pctBar = '<div class="pct-bar"><div class="pct-track"><div class="pct-fill'
                 + (isDone ? ' done' : '') + '" style="width:' + pct + '%"></div></div>'
                 + '<span>' + pct + '%</span></div>';
      html += '<tr data-id="' + esc(t.id) + '" data-type="torrent">'
            + '<td class="t-num">' + (i + 1) + '</td>'
            + '<td class="t-title" title="' + esc(t.name) + '">' + esc(t.name || '—') + '</td>'
            + '<td class="t-size">' + fmtSize(t.totalLength || t.size || 0) + '</td>'
            + '<td class="t-seeds">' + seeds + '</td>'
            + '<td class="t-speed">' + speed + '</td>'
            + '<td class="t-pct">' + (isDone ? '<span style="color:var(--ok)">Done</span>' : isErr ? '<span style="color:var(--err)">Failed</span>' : pctBar) + '</td>'
            + '<td class="t-dest">' + esc(dest) + '</td>'
            + '<td class="t-action">';
      if (state === 'downloading') html += '<button class="btn-sm" data-action="pause">Pause</button> ';
      if (state === 'paused')      html += '<button class="btn-sm" data-action="resume">Resume</button> ';
      if (!isDone && !isErr)       html += '<button class="btn-sm cancel-btn" data-action="cancel">Cancel</button>';
      html += '</td></tr>';
    }
    html += '</tbody></table>';
    wrap.innerHTML = html;
    _wireDlActions(wrap);
  }

  // ── DDL downloads table ───────────────────────────────────────────────────

  function renderDdlDownloads(directs) {
    var wrap = document.getElementById('ddlDlWrap');
    var dl = directs || [];
    if (!dl.length) {
      wrap.innerHTML = '<div class="tbl-empty">No active direct downloads.</div>';
      return;
    }
    var html = '<table class="data-table"><thead><tr>'
             + '<th class="t-num">#</th><th class="t-title">Filename</th>'
             + '<th class="t-size">Size</th><th class="t-speed">Speed</th>'
             + '<th class="t-pct">Progress</th><th class="t-type">Type</th>'
             + '<th class="t-dest">Dest</th><th></th>'
             + '</tr></thead><tbody>';
    for (var j = 0; j < dl.length; j++) {
      var d  = dl[j];
      var ds = String(d.state || '');
      var total = Number(d.totalBytes || d.total || 0);
      var recv  = Number(d.receivedBytes || d.received || 0);
      var dpct  = total > 0 ? Math.min(100, Math.round(recv / total * 100)) : 0;
      var dDone = (ds === 'completed' || ds === 'complete');
      var dErr  = (ds === 'failed' || ds === 'cancelled');
      var dSpeed = (ds === 'downloading') ? fmtSpeed(d.downloadSpeed || d.speed || 0) : '—';
      var fname = String(d.filename || d.url || '');
      var ext   = fileExt(fname);
      var dest  = String(d.library || d.destination || d.dest || '').split(/[\\/]/).pop() || '—';
      var pctBar = '<div class="pct-bar"><div class="pct-track"><div class="pct-fill'
                 + (dDone ? ' done' : '') + '" style="width:' + dpct + '%"></div></div>'
                 + '<span>' + dpct + '%</span></div>';
      html += '<tr data-id="' + esc(d.id) + '" data-type="direct">'
            + '<td class="t-num">' + (j + 1) + '</td>'
            + '<td class="t-title" title="' + esc(fname) + '">' + esc(fname) + '</td>'
            + '<td class="t-size">' + fmtSize(total) + '</td>'
            + '<td class="t-speed">' + dSpeed + '</td>'
            + '<td class="t-pct">' + (dDone ? '<span style="color:var(--ok)">Done</span>' : dErr ? '<span style="color:var(--err)">Failed</span>' : pctBar) + '</td>'
            + '<td class="t-type">' + esc(ext) + '</td>'
            + '<td class="t-dest">' + esc(dest) + '</td>'
            + '<td class="t-action">';
      if (ds === 'downloading') html += '<button class="btn-sm" data-action="pause">Pause</button> ';
      if (ds === 'paused')      html += '<button class="btn-sm" data-action="resume">Resume</button> ';
      if (!dDone && !dErr)      html += '<button class="btn-sm cancel-btn" data-action="cancel">Cancel</button>';
      html += '</td></tr>';
    }
    html += '</tbody></table>';
    wrap.innerHTML = html;
    _wireDlActions(wrap);
  }

  function _wireDlActions(wrap) {
    wrap.querySelectorAll('.btn-sm[data-action]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var row  = btn.closest('tr');
        if (!row || !window.electronAPI) return;
        var id   = row.getAttribute('data-id');
        var type = row.getAttribute('data-type');
        var act  = btn.getAttribute('data-action');
        if (type === 'torrent') {
          if (act === 'pause')  window.electronAPI.webTorrent.pause({id: id}).catch(function(){});
          if (act === 'resume') window.electronAPI.webTorrent.resume({id: id}).catch(function(){});
          if (act === 'cancel') window.electronAPI.webTorrent.cancel({id: id}).catch(function(){});
        } else {
          if (act === 'pause')  window.electronAPI.webSources.pauseDownload({id: id}).catch(function(){});
          if (act === 'resume') window.electronAPI.webSources.resumeDownload({id: id}).catch(function(){});
          if (act === 'cancel') window.electronAPI.webSources.cancelDownload({id: id}).catch(function(){});
        }
        setTimeout(refreshDownloads, 600);
      });
    });
  }

  // ── Refresh downloads ──────────────────────────────────────────────────────

  var _dlPollTimer = null;

  function refreshDownloads() {
    var api = window.electronAPI;
    if (!api) return;
    var torrents = [];
    api.webTorrent.getActive()
      .then(function (r) {
        torrents = (r && r.torrents) ? r.torrents : [];
        renderTorrentDownloads(torrents);
        return api.webSources.getDownloadHistory({limit: 30});
      })
      .then(function (r) {
        renderDdlDownloads((r && r.downloads) ? r.downloads : []);
      })
      .catch(function () {
        renderTorrentDownloads(torrents);
      });
  }

  // ── Init on bridge ready ───────────────────────────────────────────────────

  function init() {
    var api = window.electronAPI;
    if (!api) return;

    // Apply saved theme
    api.shell.getAppTheme()
      .then(function (r) {
        if (r && r.theme) window._tankwebApplyTheme(r.theme);
      })
      .catch(function(){});

    // Load sources
    api.webSources.get()
      .then(function (r) { renderSources(r && r.sources ? r.sources : []); })
      .catch(function () { renderSources([]); });

    // Load downloads
    refreshDownloads();

    // Poll downloads every 3s
    if (_dlPollTimer) clearInterval(_dlPollTimer);
    _dlPollTimer = setInterval(refreshDownloads, 3000);

    // Live progress events
    api.webTorrent.onProgress(function ()  { refreshDownloads(); });
    api.webTorrent.onStarted(function ()   { refreshDownloads(); });
    api.webTorrent.onCompleted(function () { refreshDownloads(); });
    api.webSources.onDownloadProgress(function ()  { refreshDownloads(); });
    api.webSources.onDownloadCompleted(function () { refreshDownloads(); });
    api.webSources.onUpdated(function (r) {
      if (r && r.sources) renderSources(r.sources);
    });

    // Auto-intercept magnet links from browser tabs
    api.webTabManager.onMagnetRequested(function (payload) {
      var url = (payload && (payload.url || payload)) || '';
      if (!url || !url.startsWith('magnet:')) return;
      api.webTorrent.startMagnet({magnetUri: url})
        .then(function (r) {
          showToast(r && r.ok ? 'Download started' : 'Could not start: ' + ((r && r.error) || 'unknown'));
          if (r && r.ok) refreshDownloads();
        })
        .catch(function () { showToast('Magnet error'); });
    });
  }

  if (window.electronAPI) {
    init();
  } else {
    document.addEventListener('electronAPI:ready', init, {once: true});
    var _poll = setInterval(function () {
      if (window.electronAPI) { clearInterval(_poll); init(); }
    }, 200);
    setTimeout(function () { clearInterval(_poll); }, 10000);
  }

})();
</script>
</body>
</html>
